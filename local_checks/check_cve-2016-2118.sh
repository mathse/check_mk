#!/bin/bash
# Addresses CVE-2016-2118
# This checks if the samba version is installed (badlock)

cve=2016-2118
name=check_cve-$cve
nicename=badlock
package=samba
versions="(3.6.|4.0.|4.1.|4.2.0|4.2.1|4.2.2|4.2.3|4.2.4|4.2.5|4.2.6|4.2.7|4.2.8|4.2.9|4.3.0|4.3.1|4.3.2|4.3.3|4.3.4|4.3.5|4.3.6|4.4.0)"
operatingsystem=$(facter operatingsystem)

if [ "$operatingsystem" == "Ubuntu" ]
then
	lsbdistrelease=$(facter lsbdistrelease)
	service=samba
	if [ $(dpkg -s $package | grep Version | awk '{ print $2 }' | egrep "$versions" | wc -l) -eq 0 ]
	then
		exitCode=0
	fi 
fi
if [ "$operatingsystem" == "CentOS" ]
then
	hardwaremodel=$(facter hardwaremodel)
	service=smb
	if [ $(rpm -q $package | egrep "$package-$versions" | grep $hardwaremodel | wc -l) -eq 0 ]
	then
		exitCode=0
	fi 
fi
if [ "$operatingsystem" == "SLES" ]
then
	service=smb
	if [ $(rpm -q $package | egrep "$versions" | wc -l) -eq 0 ]	
	then
		exitCode=0
	fi
fi

if [ "$exitCode" == "0" ]
then
	echo "0 $name - Patched against CVE-$cve"
else
	service $service status &> /dev/null
	if [ $? -eq 0 ]
	then
		echo "2 $name - Vulnerable to CVE-$cve ($nicename) - Update now your $package package!"
	else
		echo "0 $name - Vulnerable to CVE-$cve ($nicename) but service is not $service running - Update now your $package package before using the service"
	fi
fi
